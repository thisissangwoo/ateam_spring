<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hp.mapper">
	
	<!-- 병원상세조회(카카오맵) -->
	<select id="detailmap" resultType="hp.Hp_infoVO">
		select  hp.* ,START_M,END_M,START_T,END_T,
		START_W,END_W,START_TH,END_TH,START_F,END_F,
		START_S,END_S,START_SU,END_SU,
		LUNCH_D,LUNCH_W,CLOSE_SU,CLOSE_HO 
		from hp
		left outer join hp_time 
		on  hp.hp_code = hp_time.hp_code 
		where hp_name like '%'||#{place_name}||'%' and hp_tel like '%'||#{phone}||'%'
	</select> 
	<!-- <select id="detailmap" resultType="hp.Hp_infoVO">
		select  hp.hp_code, hp.hp_name, hp.hp_addr, hp.hp_tel, hp.hp_url, hp.hp_x, hp.hp_y, start_m,end_m,start_t,end_t,
				start_w,end_w,start_th,end_th,start_f,end_f,start_s,end_s,start_su,end_su, lunch_d,lunch_w,close_su,close_ho , 
        count(rev_num) as totalcnt, count(case when rev_text1 = 1 then 0 end) survey1cnt, count(case when rev_text2 = 1 then 0 end) survey2cnt,
        count(case when rev_text3 = 1 then 0 end) survey3cnt , 
        Round(avg(rev_grade),2) totalrate, Round(avg(rev_text1),2) survey1rate, Round(avg(rev_text2),2) survey2rate, Round(avg(rev_text3),2) survey3rate
		from hp
		left outer join hp_time 
		on  hp.hp_code = hp_time.hp_code 
        left outer join review r
        on hp.hp_code = r.hp_code
        group by hp.hp_code, hp.hp_name, hp.hp_addr, hp.hp_tel, hp.hp_url, hp.hp_x, hp.hp_y, START_M, END_M, START_T, 
                        END_T, START_W, END_W, START_TH, END_TH, START_F, END_F, START_S, END_S, START_SU, END_SU, LUNCH_D, LUNCH_W, CLOSE_SU, CLOSE_HO
		Having hp_name like '%'||#{place_name}||'%' and hp_tel like '%'||#{phone}||'%'
		</select> -->
	
	<!-- 병원상세조회 -->
	<select id="detailhp" resultType="hp.Hp_infoVO">
		select  hp.* ,START_M,END_M,START_T,END_T,
		START_W,END_W,START_TH,END_TH,START_F,END_F,
		START_S,END_S,START_SU,END_SU,
		LUNCH_D,LUNCH_W,CLOSE_SU,CLOSE_HO 
		from hp
		left outer join hp_time 
		on  hp.hp_code = hp_time.hp_code 
		where hp.hp_code = #{code}
	</select> 
	
<!-- 	<select id="detailhp" resultType="hp.Hp_infoVO">
		select  hp.hp_code, hp.hp_name, hp.hp_addr, hp.hp_tel, hp.hp_url, hp.hp_x, hp.hp_y, start_m,end_m,start_t,end_t,
				start_w,end_w,start_th,end_th,start_f,end_f,start_s,end_s,start_su,end_su, lunch_d,lunch_w,close_su,close_ho , 
        count(rev_num) as totalcnt, count(case when rev_text1 = 1 then 0 end) survey1cnt, count(case when rev_text2 = 1 then 0 end) survey2cnt,
        count(case when rev_text3 = 1 then 0 end) survey3cnt , 
        Round(avg(rev_grade),2) totalrate, Round(avg(rev_text1),2) survey1rate, Round(avg(rev_text2),2) survey2rate, Round(avg(rev_text3),2) survey3rate
		from hp
		left outer join hp_time 
		on  hp.hp_code = hp_time.hp_code 
        left outer join review r
        on hp.hp_code = r.hp_code
        group by hp.hp_code, hp.hp_name, hp.hp_addr, hp.hp_tel, hp.hp_url, hp.hp_x, hp.hp_y, START_M, END_M, START_T, 
                        END_T, START_W, END_W, START_TH, END_TH, START_F, END_F, START_S, END_S, START_SU, END_SU, LUNCH_D, LUNCH_W, CLOSE_SU, CLOSE_HO
		Having hp.hp_code = #{code}
	</select> -->
	
	<!-- 병원 찜한 여부 확인 -->
	<select id="checkheart" resultType="user.UserChoiceVO">
		select * from choice where hp_code = #{hp_code} and user_id = #{user_id} 
	</select>
	
	<!-- 찜한 병원 insert -->
	<insert id = "insertheart">
		insert into choice values(#{user_id}, #{hp_code}, #{ch_date} )
	</insert>
	<!-- 찜한 병원 날짜 수정(업데이트) -->
	<update id = "updateheart">
		update choice set ch_date = #{ch_date} where user_id = #{user_id} and hp_code = #{hp_code}
	</update>
	<!-- 찜한 병원 삭제 -->
	<delete id="deleteheart">
		delete from choice where user_id = #{user_id} and hp_code = #{hp_code}
	</delete>
	
	<!-- 찜한 병원 전체 조회 -->
	<select id="selectheart" resultType="user.UserChoiceVO">
		select choice.hp_code, user_id, hp_addr, hp_name ,hp_tel
		from choice Left outer join hp 
		on hp.hp_code = choice.hp_code 
		where user_id=#{user_id} order by ch_date desc
	</select>
</mapper>